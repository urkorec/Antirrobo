<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emisor - Escudo Irun</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; text-align: center; margin: 0; height: 100vh; overflow: hidden; background: linear-gradient(135deg, #0f2027, #203a43, #2c5364); color: white; transition: background 0.3s; }
        
        #login-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #0f172a; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10000; }
        .box { background: rgba(255, 255, 255, 0.1); padding: 40px; border-radius: 20px; backdrop-filter: blur(10px); box-shadow: 0 8px 32px rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); width: 80%; max-width: 350px;}
        .box h2 { margin-top: 0; color: #4facfe; font-weight: 800;}
        .input-pass { padding: 15px; font-size: 16px; border-radius: 12px; border: none; margin-bottom: 20px; width: 90%; text-align: center; font-family: 'Poppins'; }
        .btn-login { background: linear-gradient(45deg, #4facfe, #00f2fe); color: white; padding: 15px; font-size: 16px; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; width: 100%; transition: transform 0.2s; }
        
        #app-screen { display: none; padding: 20px; height: 100%; box-sizing: border-box; display: flex; flex-direction: column; justify-content: center; align-items: center;}
        
        .panel-control { background: rgba(0,0,0,0.4); padding: 20px; border-radius: 15px; width: 100%; max-width: 350px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.1);}
        
        button { padding: 15px; width: 100%; border-radius: 12px; border: none; font-size: 18px; font-weight: bold; cursor: pointer; margin-bottom: 15px; font-family: 'Poppins'; transition: transform 0.1s;}
        button:active { transform: scale(0.95); }
        .btn-verde { background: linear-gradient(45deg, #11998e, #38ef7d); color: white; }
        .btn-rojo { background: linear-gradient(45deg, #cb2d3e, #ef473a); color: white; display: none; }
        .btn-naranja { background: linear-gradient(45deg, #f12711, #f5af19); color: white; display: none; }
        .btn-gris { background: rgba(255,255,255,0.2); color: white; display: none; }
        
        #estado { font-size: 22px; font-weight: 800; margin-bottom: 10px; padding: 15px; border-radius: 12px; background: rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.2);}
        #coordenadas { font-size: 12px; color: #aaa; margin-bottom: 20px; font-family: monospace; background: rgba(0,0,0,0.3); padding: 8px; border-radius: 8px;}
        
        .alerta-amarilla { background: #b8860b !important; }
        .alerta-roja { background: #8b0000 !important; animation: parpadeo 0.5s infinite alternate; }
        @keyframes parpadeo { from { background: #8b0000; } to { background: #ff0000; } }

        #pantalla-negra { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 9999; display: none; flex-direction: column; justify-content: center; align-items: center; color: #222;}
        
        .radio-group { text-align: left; margin-bottom: 15px; font-size: 14px;}
        .radio-group label { display: block; margin-bottom: 10px; cursor: pointer; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px;}
        .radio-group input { margin-right: 10px; }
    </style>
</head>
<body>
    <div id="login-screen">
        <div class="box">
            <h2>üõ°Ô∏è Escudo Emisor</h2>
            <p>Se queda en la bici</p>
            <input type="password" id="inputContrasena" class="input-pass" placeholder="Contrase√±a secreta">
            <button class="btn-login" onclick="iniciarSesion()">Desbloquear</button>
        </div>
    </div>

    <div id="pantalla-negra" onclick="despertarPantalla()">
        <p>Toca para despertar</p>
    </div>

    <div id="app-screen" style="display: none;">
        <div id="estado">‚ö™ SISTEMA APAGADO</div>
        <div id="coordenadas">GPS: Apagado</div>

        <div class="panel-control" id="selector-modos">
            <div class="radio-group">
                <label><input type="radio" name="modo" value="normal" checked> üîµ <b>Modo Sigilo:</b> No suena aqu√≠. Avisa al m√≥vil y Telegram.</label>
                <label><input type="radio" name="modo" value="seguro"> üî¥ <b>Modo Alarma:</b> Pitar√° AQU√ç y avisar√° al m√≥vil y Telegram.</label>
            </div>
        </div>

        <button class="btn-verde" id="btnActivar" onclick="iniciarVigilancia()">üõ°Ô∏è Armar Escudo</button>
        <button class="btn-naranja" id="btnSimular" onclick="simularMovimiento()">üëã Simular Movimiento</button>
        <button class="btn-gris" id="btnPantalla" onclick="apagarPantalla()">Apagar Pantalla (Falso)</button>
        <button class="btn-rojo" id="btnDetener" onclick="detenerVigilancia()">üõë Desarmar Escudo</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

        // ==========================================
        // ü§ñ CONFIGURACI√ìN DE TELEGRAM (¬°Pega tus datos aqu√≠!)
        // ==========================================
        const TELEGRAM_TOKEN = "8565258420:AAHB5CHbTJChcFvyW5FMiZ2Jl_tpnSDM8Ho"; 
        const TELEGRAM_CHAT_ID = "1156363611";

        function avisarTelegram(modo) {
            if (TELEGRAM_TOKEN === "8565258420:AAHB5CHbTJChcFvyW5FMiZ2Jl_tpnSDM8Ho" || !TELEGRAM_CHAT_ID) return;
            
            let texto = "üö® ¬°ATENCI√ìN! ROBO DETECTADO üö®\n\nTu bicicleta est√° en movimiento.";
            if (modo === "normal") texto += "\nü§´ (Modo Sigilo: El ladr√≥n no sabe que lo est√°s viendo).";
            
            const url = `https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage?chat_id=${TELEGRAM_CHAT_ID}&text=${encodeURIComponent(texto)}`;
            fetch(url).catch(e => console.log("Error enviando Telegram:", e));
        }
        // ==========================================

        const app = initializeApp({
            apiKey: "AIzaSyCtStv8wmlLNOhiw0lnc9mzVlQwLXrYdbY",
            authDomain: "antirrobo-457ef.firebaseapp.com",
            projectId: "antirrobo-457ef"
        });
        const db = getFirestore(app);

        let BUZON = "", vigilando = false, nivel = 0, lastX = null, lastY = null, lastZ = null;
        let latActual = 43.3390, lonActual = -1.7896; 
        let gpsTracker = null;
        let wakeLock = null;
        
        let aviso = new Audio('https://actions.google.com/sounds/v1/alarms/beeping_alarm.ogg');
        let alarma = new Audio('https://actions.google.com/sounds/v1/alarms/fire_alarm_classic.ogg');
        alarma.loop = true;

        window.iniciarSesion = function() {
            BUZON = document.getElementById('inputContrasena').value.trim();
            if (!BUZON) return;
            
            aviso.load(); alarma.load();
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-screen').style.display = 'flex';

            onSnapshot(doc(db, "dispositivos", BUZON), (docSnap) => {
                if (docSnap.exists() && vigilando) {
                    let cmd = docSnap.data().comando;
                    if (cmd === "apagar") detenerVigilancia();
                    else if (cmd === "silenciar") silenciar();
                }
            });
        };

        async function mantenerDespierto() {
            try { wakeLock = await navigator.wakeLock.request('screen'); } catch (err) { console.log("WakeLock fall√≥", err); }
        }

        window.apagarPantalla = function() { document.getElementById('pantalla-negra').style.display = 'flex'; }
        window.despertarPantalla = function() { document.getElementById('pantalla-negra').style.display = 'none'; }

        function enviarDatos() {
            if(!BUZON) return;
            let modo = document.querySelector('input[name="modo"]:checked').value;
            setDoc(doc(db, "dispositivos", BUZON), { 
                nivelAlarma: nivel, modo: modo, activo: vigilando, comando: "", latitud: latActual, longitud: lonActual
            }, { merge: true });
        }

        window.iniciarVigilancia = function() {
            vigilando = true; nivel = 0; mantengoDespierto = true; mantenerDespierto();
            
            document.getElementById('btnActivar').style.display = "none";
            document.getElementById('selector-modos').style.display = "none";
            document.getElementById('btnSimular').style.display = "block";
            document.getElementById('btnPantalla').style.display = "block";
            document.getElementById('btnDetener').style.display = "block";
            document.getElementById('estado').innerText = "üü¢ VIGILANCIA ACTIVA";
            
            iniciarRastreoGPS();
            enviarDatos();

            if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                DeviceMotionEvent.requestPermission().then(est => { if(est === 'granted') window.addEventListener('devicemotion', detectar); });
            } else {
                window.addEventListener('devicemotion', detectar);
            }
        };

        window.simularMovimiento = function() { if (vigilando) procesarMovimiento(); };

        function detectar(e) {
            if (!vigilando || nivel === 2) return;
            let acc = e.accelerationIncludingGravity || e.acceleration;
            if (!acc || acc.x === null) return;
            if (lastX !== null) {
                let diff = Math.abs(acc.x - lastX) + Math.abs(acc.y - lastY) + Math.abs(acc.z - lastZ);
                if (diff > 12) procesarMovimiento();
            }
            lastX = acc.x; lastY = acc.y; lastZ = acc.z;
        }

        function procesarMovimiento() {
            let modo = document.querySelector('input[name="modo"]:checked').value;
            if (nivel === 0) {
                nivel = 1; document.body.className = 'alerta-amarilla'; document.getElementById('estado').innerText = "üü° MOVIMIENTO DETECTADO";
                if (modo === "seguro") aviso.play();
                enviarDatos();
                setTimeout(() => { if (nivel === 1) silenciar(); }, 5000);
            } else if (nivel === 1) {
                nivel = 2; document.body.className = 'alerta-roja'; document.getElementById('estado').innerText = "üî¥ ALARMA - ROBO EN CURSO";
                if (modo === "seguro") alarma.play();
                
                enviarDatos();
                
                // üî• AQU√ç DISPARAMOS EL MENSAJE DE TELEGRAM üî•
                avisarTelegram(modo);
            }
        }

        window.silenciar = function() {
            nivel = 0; aviso.pause(); alarma.pause(); aviso.currentTime = 0; alarma.currentTime = 0;
            document.body.className = ''; document.getElementById('estado').innerText = "üü¢ VIGILANCIA ACTIVA"; enviarDatos();
        };

        window.detenerVigilancia = function() {
            vigilando = false; silenciar(); window.removeEventListener('devicemotion', detectar);
            if (gpsTracker) navigator.geolocation.clearWatch(gpsTracker);
            if (wakeLock !== null) { wakeLock.release(); wakeLock = null; }
            
            document.getElementById('pantalla-negra').style.display = 'none';
            document.getElementById('estado').innerText = "‚ö™ SISTEMA APAGADO";
            document.getElementById('coordenadas').innerText = "GPS: Apagado";
            document.getElementById('btnSimular').style.display = "none";
            document.getElementById('btnPantalla').style.display = "none";
            document.getElementById('btnDetener').style.display = "none";
            document.getElementById('selector-modos').style.display = "block";
            document.getElementById('btnActivar').style.display = "block";
            enviarDatos();
        };

        function iniciarRastreoGPS() {
            document.getElementById('coordenadas').innerText = "üìç Activando GPS...";
            if (navigator.geolocation) {
                gpsTracker = navigator.geolocation.watchPosition(
                    (pos) => { latActual = pos.coords.latitude; lonActual = pos.coords.longitude; document.getElementById('coordenadas').innerText = `üìç Pos: ${latActual.toFixed(5)}, ${lonActual.toFixed(5)}`; enviarDatos(); },
                    ()    => { document.getElementById('coordenadas').innerText = "‚ùå Error GPS"; },
                    { enableHighAccuracy: true, maximumAge: 3000, timeout: 8000 }
                );
            }
        }
    </script>
</body>
</html>
