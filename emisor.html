<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emisor - Escudo Irun</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; margin: 0; height: 100vh; overflow: hidden; background-color: #f4f4f4; transition: background 0.3s; }
        #login-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #1a1a2e; color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10000; }
        .input-pass { padding: 15px; font-size: 18px; border-radius: 8px; border: none; margin-bottom: 20px; width: 80%; max-width: 300px; text-align: center; }
        .btn-login { background: #4facfe; color: white; padding: 15px 30px; font-size: 18px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; width: 80%; max-width: 300px; }
        
        #app-screen { display: none; padding: 20px; }
        .btn { padding: 15px 20px; font-size: 18px; color: white; border: none; border-radius: 10px; cursor: pointer; margin: 10px; box-shadow: 0px 4px 6px rgba(0,0,0,0.2); width: 80%; max-width: 300px; }
        .btn-activar { background-color: #4CAF50; }
        .btn-detener { background-color: #d9534f; display: none; }
        .btn-pantalla { background-color: #111; display: none; }
        
        .modos-container { background: white; padding: 15px; border-radius: 10px; display: inline-block; text-align: left; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; width: 80%; max-width: 300px;}
        .modos-container label { display: block; font-size: 16px; margin: 10px 0; cursor: pointer; color: #333;}
        
        #estado { margin-top: 10px; font-size: 20px; font-weight: bold; color: #333; padding: 15px; border-radius: 10px; }
        #coordenadas { margin-top: 10px; font-size: 14px; color: #444; background: #fff; padding: 10px; border-radius: 8px; border: 1px solid #ddd; }
        .alerta-amarilla { background-color: #ffcc00 !important; }
        .alerta-roja { background-color: #ff0000 !important; color: white !important; animation: parpadeo 0.3s infinite; }
        @keyframes parpadeo { 0% { background-color: #ff0000; } 50% { background-color: #8b0000; } 100% { background-color: #ff0000; } }
        
        #pantalla-negra { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: black; z-index: 9999; display: none; color: #555; display: flex; align-items: center; justify-content: center; font-size: 14px; flex-direction: column; }
    </style>
</head>
<body>
    <div id="login-screen">
        <h2>üîí Seguridad del Emisor</h2>
        <p>Crea una contrase√±a para esta sesi√≥n:</p>
        <input type="password" id="inputContrasena" class="input-pass" placeholder="Ej: MiBiciSecreta123">
        <button class="btn-login" onclick="iniciarSesion()">Entrar</button>
    </div>

    <div id="app-screen">
        <div id="pantalla-negra" onclick="toqueDesbloqueo()">
            <div>Pantalla Apagada</div>
            <div style="font-size:10px; margin-top:10px;">(Toca 3 veces r√°pido para encender)</div>
        </div>
        
        <h1>üö® Sensor Antirrobo</h1>
        
        <div class="modos-container" id="selector-modos">
            <label><input type="radio" name="modoVigilancia" value="normal" checked> üîµ <b>Modo Normal</b><br><small style="color:#777;">Tolerancia 30s antes de pitar.</small></label>
            <label><input type="radio" name="modoVigilancia" value="seguro"> üî¥ <b>Modo Seguro</b><br><small style="color:#777;">Aviso inmediato al m√≠nimo roce.</small></label>
        </div>

        <button class="btn btn-activar" id="btnActivar" onclick="iniciarVigilancia()">üü¢ Activar Vigilancia</button>
        <button class="btn btn-pantalla" id="btnPantalla" onclick="apagarPantalla()">üï∂Ô∏è Apagar Pantalla</button>
        <button class="btn btn-detener" id="btnDetener" onclick="detenerVigilancia()">üõë Detener Manualmente</button>
        
        <div id="estado">Estado: Apagado</div>
        <div id="coordenadas">GPS: En reposo</div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCtStv8wmlLNOhiw0lnc9mzVlQwLXrYdbY",
            authDomain: "antirrobo-457ef.firebaseapp.com",
            projectId: "antirrobo-457ef",
            storageBucket: "antirrobo-457ef.firebasestorage.app",
            messagingSenderId: "237396778046",
            appId: "1:237396778046:web:6da1715323e4581142856f"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let BUZON_SECRETO = "";
        let vigilando = false;
        let nivelAlarma = 0; 
        let tiempoUltimoAviso = 0;
        let temporizadorNormal = null;
        let lastX = null, lastY = null, lastZ = null;
        let gpsTracker = null;
        let wakeLock = null;
        let toquesDesbloqueo = 0;
        
        let latActual = 43.3390; 
        let lonActual = -1.7896;

        let sonidoAviso = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');
        let sonidoAlarma = new Audio('https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg');
        sonidoAlarma.loop = true;

        window.iniciarSesion = function() {
            BUZON_SECRETO = document.getElementById('inputContrasena').value.trim();
            if (BUZON_SECRETO === "") return alert("Introduce una contrase√±a.");
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-screen').style.display = 'block';

            onSnapshot(doc(db, "dispositivos", BUZON_SECRETO), (documento) => {
                if (documento.exists() && documento.data().comando === "apagar" && vigilando) {
                    window.detenerVigilancia();
                    setDoc(doc(db, "dispositivos", BUZON_SECRETO), { comando: "" }, { merge: true });
                }
            });
        };

        function obtenerModo() { return document.querySelector('input[name="modoVigilancia"]:checked').value; }

        function enviarDatos() {
            if(!BUZON_SECRETO) return;
            // A√ëADIDO: 'activo: vigilando' para informar al monitor del estado real
            setDoc(doc(db, "dispositivos", BUZON_SECRETO), {
                latitud: latActual, longitud: lonActual, nivelAlarma: nivelAlarma, modo: obtenerModo(), tiempo: Date.now(), activo: vigilando
            }, { merge: true }).catch(e => console.error(e));
        }

        async function mantenerPantallaEncendida() {
            try { if ('wakeLock' in navigator) wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {}
        }

        window.apagarPantalla = function() { document.getElementById('pantalla-negra').style.display = 'flex'; }

        window.toqueDesbloqueo = function() {
            toquesDesbloqueo++;
            if (toquesDesbloqueo >= 3) {
                document.getElementById('pantalla-negra').style.display = 'none';
                toquesDesbloqueo = 0;
            }
            setTimeout(() => { toquesDesbloqueo = 0; }, 2000);
        }

        window.iniciarVigilancia = function() {
            sonidoAviso.play().then(() => sonidoAviso.pause()).catch(() => {});
            sonidoAlarma.play().then(() => sonidoAlarma.pause()).catch(() => {});

            if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                DeviceMotionEvent.requestPermission().then(estado => { if (estado === 'granted') activarSensores(); });
            } else { activarSensores(); }
        };

        function activarSensores() {
            vigilando = true; nivelAlarma = 0;
            document.getElementById('selector-modos').style.display = "none";
            document.getElementById('estado').innerText = "üü¢ Vigilando (" + obtenerModo().toUpperCase() + ")";
            document.getElementById('btnActivar').style.display = "none";
            document.getElementById('btnPantalla').style.display = "inline-block";
            document.getElementById('btnDetener').style.display = "inline-block";
            
            mantenerPantallaEncendida(); 
            enviarDatos();
            window.addEventListener('devicemotion', detectarGolpe);
        }

        function detectarGolpe(evento) {
            if (!vigilando || nivelAlarma === 2) return;
            let acc = evento.accelerationIncludingGravity || evento.acceleration;
            if (!acc || acc.x === null) return;
            if (lastX !== null) {
                let diff = Math.abs(acc.x - lastX) + Math.abs(acc.y - lastY) + Math.abs(acc.z - lastZ);
                if (diff > 10) procesarMovimiento();
            }
            lastX = acc.x; lastY = acc.y; lastZ = acc.z;
        }

        function procesarMovimiento() {
            let ahora = Date.now();
            let modo = obtenerModo();

            if (modo === "normal") {
                if (nivelAlarma === 0) {
                    nivelAlarma = 1; tiempoUltimoAviso = ahora; enviarDatos(); 
                    if(temporizadorNormal) clearTimeout(temporizadorNormal);
                    temporizadorNormal = setTimeout(() => {
                        if (nivelAlarma === 1) { 
                            nivelAlarma = 0; enviarDatos();
                            document.getElementById('estado').innerText = "üü¢ Vigilando (NORMAL)";
                        }
                    }, 30000);
                } else if (nivelAlarma === 1 && (ahora - tiempoUltimoAviso > 2000)) {
                    nivelAlarma = 2; if(temporizadorNormal) clearTimeout(temporizadorNormal); dispararAlarmaGeneral();
                }
            } else if (modo === "seguro") {
                if (nivelAlarma === 0) {
                    nivelAlarma = 1; tiempoUltimoAviso = ahora;
                    sonidoAviso.currentTime = 0; sonidoAviso.play();
                    document.body.className = 'alerta-amarilla';
                    document.getElementById('estado').innerText = "‚ö†Ô∏è ADVERTENCIA INMEDIATA";
                    iniciarRastreoGPS(); enviarDatos(); 
                } else if (nivelAlarma === 1 && (ahora - tiempoUltimoAviso > 2000)) {
                    nivelAlarma = 2; dispararAlarmaGeneral();
                }
            }
        }

        function dispararAlarmaGeneral() {
            document.body.className = 'alerta-roja';
            document.getElementById('estado').innerText = "üî¥ ¬°ROBO CONFIRMADO!";
            sonidoAlarma.play();
            iniciarRastreoGPS(); 
            enviarDatos(); 
        }

        window.detenerVigilancia = function() {
            vigilando = false; nivelAlarma = 0; 
            if(temporizadorNormal) clearTimeout(temporizadorNormal);
            sonidoAviso.pause(); sonidoAviso.currentTime = 0;
            sonidoAlarma.pause(); sonidoAlarma.currentTime = 0;
            
            window.removeEventListener('devicemotion', detectarGolpe);
            if (gpsTracker !== null) { navigator.geolocation.clearWatch(gpsTracker); gpsTracker = null; }
            if (wakeLock !== null) { wakeLock.release(); wakeLock = null; }
            
            document.getElementById('pantalla-negra').style.display = 'none';
            document.body.className = '';
            document.getElementById('estado').innerText = "‚ö™ Sistema Apagado";
            document.getElementById('coordenadas').innerText = "GPS: Apagado";
            
            document.getElementById('selector-modos').style.display = "inline-block";
            document.getElementById('btnActivar').style.display = "inline-block";
            document.getElementById('btnPantalla').style.display = "none";
            document.getElementById('btnDetener').style.display = "none";
            enviarDatos(); 
        };

        function iniciarRastreoGPS() {
            document.getElementById('coordenadas').innerText = "üìç Activando GPS de precisi√≥n...";
            if (navigator.geolocation) {
                gpsTracker = navigator.geolocation.watchPosition((posicion) => {
                    latActual = posicion.coords.latitude; lonActual = posicion.coords.longitude;
                    document.getElementById('coordenadas').innerText = `üìç GPS Activo: ${latActual.toFixed(5)}, ${lonActual.toFixed(5)}`;
                    enviarDatos();
                }, (error) => { document.getElementById('coordenadas').innerText = "‚ùå Error GPS"; }, { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 });
            }
        }
    </script>
</body>
</html>
