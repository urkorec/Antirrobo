<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emisor - Escudo Irun</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; text-align: center; margin: 0; height: 100vh; overflow: hidden; background: linear-gradient(135deg, #0f2027, #203a43, #2c5364); color: white; transition: background 0.3s; }
        
        #login-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #0f172a; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10000; }
        .box { background: rgba(255, 255, 255, 0.1); padding: 40px; border-radius: 20px; backdrop-filter: blur(10px); box-shadow: 0 8px 32px rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); width: 80%; max-width: 350px; }
        .box h2 { margin-top: 0; font-weight: 800; font-size: 24px; color: #4facfe; }
        .input-pass { padding: 15px; font-size: 16px; border-radius: 12px; border: none; margin-bottom: 20px; width: 90%; text-align: center; outline: none; font-family: 'Poppins', sans-serif; background: rgba(255,255,255,0.9); }
        .btn-login { background: linear-gradient(45deg, #4facfe, #00f2fe); color: white; padding: 15px; font-size: 18px; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; width: 100%; transition: transform 0.2s; }
        
        #app-screen { display: none; padding: 20px; height: 100%; box-sizing: border-box; flex-direction: column; align-items: center; }
        h1 { font-weight: 800; margin-bottom: 5px; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
        
        .modos-container { background: rgba(255,255,255,0.05); padding: 20px; border-radius: 16px; text-align: left; box-shadow: 0 4px 15px rgba(0,0,0,0.2); margin: 20px 0; width: 90%; max-width: 350px; border: 1px solid rgba(255,255,255,0.1); }
        .modos-container label { display: block; font-size: 16px; margin: 15px 0; cursor: pointer; padding: 10px; border-radius: 8px; transition: background 0.2s; }
        .modos-container small { color: #aaa; display: block; margin-top: 5px; font-size: 13px; margin-left: 28px;}
        
        .btn { padding: 18px; font-size: 18px; color: white; border: none; border-radius: 12px; cursor: pointer; margin: 10px 0; font-weight: 600; width: 90%; max-width: 350px; transition: all 0.2s; text-transform: uppercase; letter-spacing: 1px; }
        .btn-activar  { background: linear-gradient(45deg, #11998e, #38ef7d); box-shadow: 0 4px 15px rgba(56,239,125,0.4); }
        .btn-detener  { background: linear-gradient(45deg, #cb2d3e, #ef473a); box-shadow: 0 4px 15px rgba(239,71,58,0.4); display: none; }
        .btn-pantalla { background: rgba(0,0,0,0.6); border: 1px solid rgba(255,255,255,0.2); display: none; }
        .btn-simular  { background: rgba(243, 156, 18, 0.8); border: 2px dashed #f1c40f; display: none; }

        #estado { margin-top: 20px; font-size: 20px; font-weight: 800; padding: 15px; border-radius: 12px; background: rgba(0,0,0,0.4); width: 90%; max-width: 350px; backdrop-filter: blur(5px); }
        #coordenadas { margin-top: 10px; font-size: 13px; color: #ddd; background: rgba(0,0,0,0.4); padding: 10px; border-radius: 8px; width: 90%; max-width: 350px; }
        
        .alerta-amarilla { background: #d4af37 !important; color: #000; }
        .alerta-roja { background: #8b0000 !important; animation: latido 0.3s infinite alternate; }
        @keyframes latido { from { background: #ff0000; } to { background: #8b0000; } }
        
        #pantalla-negra { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: black; z-index: 9999; display: none; color: #333; flex-direction: column; align-items: center; justify-content: center; font-size: 14px; }
    </style>
</head>
<body>
    <div id="login-screen">
        <div class="box">
            <h2>üõ°Ô∏è Escudo Emisor</h2>
            <p>Protege tu veh√≠culo</p>
            <input type="password" id="inputContrasena" class="input-pass" placeholder="Tu contrase√±a secreta">
            <button class="btn-login" onclick="iniciarSesion()">Desbloquear</button>
        </div>
    </div>

    <div id="app-screen">
        <div id="pantalla-negra" onclick="toqueDesbloqueo()">
            <div>(Toca 3 veces para despertar)</div>
        </div>
        
        <h1>üö® Antirrobo ACTIVO</h1>
        
        <div class="modos-container" id="selector-modos">
            <label><input type="radio" name="modoVigilancia" value="normal" checked> üîµ <b>Modo Sigilo (Normal)</b><br><small>Avisa al monitor en silencio.</small></label>
            <label><input type="radio" name="modoVigilancia" value="seguro"> üî¥ <b>Modo Alarma (Seguro)</b><br><small>Sonido estridente al moverla.</small></label>
        </div>

        <button class="btn btn-activar"  id="btnActivar"  onclick="iniciarVigilancia()">Escudar Veh√≠culo</button>
        <button class="btn btn-simular"  id="btnSimular"  onclick="simularMovimiento()">üëã Simular Movimiento</button>
        <button class="btn btn-pantalla" id="btnPantalla" onclick="apagarPantalla()">üï∂Ô∏è Oscurecer Pantalla</button>
        <button class="btn btn-detener"  id="btnDetener"  onclick="detenerVigilancia()">üõë Desactivar Escudo</button>
        
        <div id="estado">‚ö™ Reposo</div>
        <div id="coordenadas">GPS: Esperando activaci√≥n</div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCtStv8wmlLNOhiw0lnc9mzVlQwLXrYdbY",
            authDomain: "antirrobo-457ef.firebaseapp.com",
            projectId: "antirrobo-457ef"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let BUZON_SECRETO = "";
        let vigilando = false, nivelAlarma = 0, tiempoUltimoAviso = 0;
        let temporizadorNormal = null, lastX = null, lastY = null, lastZ = null;
        let gpsTracker = null, wakeLock = null, toquesDesbloqueo = 0;
        let latActual = 43.3390, lonActual = -1.7896;

        // =============================================
        // AUDIO: Alarma de veh√≠culo multi-fase
        // =============================================
        let audioCtx = null;
        let alarmaRunning = false;
        let alarmaTimeout = null;

        function getAudioCtx() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
            return audioCtx;
        }

        function playAviso() {
            const ctx = getAudioCtx();
            [0, 200, 400].forEach(delay => {
                setTimeout(() => {
                    const osc = ctx.createOscillator(); const g = ctx.createGain();
                    osc.connect(g); g.connect(ctx.destination);
                    osc.type = 'sine'; osc.frequency.value = 1050;
                    g.gain.setValueAtTime(0.5, ctx.currentTime);
                    g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.15);
                    osc.start(ctx.currentTime); osc.stop(ctx.currentTime + 0.15);
                }, delay);
            });
        }

        function iniciarAlarma() {
            if (alarmaRunning) return;
            alarmaRunning = true;

            const ctx = getAudioCtx();
            const comp = ctx.createDynamicsCompressor();
            comp.threshold.value = -4; comp.knee.value = 6; comp.ratio.value = 10;
            comp.connect(ctx.destination);

            function faseA(cb) {
                let i = 0;
                function chirp() {
                    if (!alarmaRunning) return;
                    const t = ctx.currentTime;
                    const osc1 = ctx.createOscillator(); const g1 = ctx.createGain();
                    osc1.type = 'sawtooth';
                    osc1.frequency.setValueAtTime(900, t);
                    osc1.frequency.exponentialRampToValueAtTime(1450, t + 0.12);
                    g1.gain.setValueAtTime(0.7, t); g1.gain.linearRampToValueAtTime(0, t + 0.12);
                    osc1.connect(g1); g1.connect(comp); osc1.start(t); osc1.stop(t + 0.13);

                    const osc2 = ctx.createOscillator(); const g2 = ctx.createGain();
                    osc2.type = 'sawtooth';
                    osc2.frequency.setValueAtTime(1450, t + 0.12);
                    osc2.frequency.exponentialRampToValueAtTime(780, t + 0.24);
                    g2.gain.setValueAtTime(0, t + 0.12); g2.gain.linearRampToValueAtTime(0.65, t + 0.13);
                    g2.gain.linearRampToValueAtTime(0, t + 0.24);
                    osc2.connect(g2); g2.connect(comp); osc2.start(t + 0.12); osc2.stop(t + 0.25);

                    const osc3 = ctx.createOscillator(); const g3 = ctx.createGain();
                    osc3.type = 'square';
                    osc3.frequency.setValueAtTime(1350, t);
                    osc3.frequency.exponentialRampToValueAtTime(2175, t + 0.12);
                    osc3.frequency.exponentialRampToValueAtTime(1170, t + 0.24);
                    g3.gain.setValueAtTime(0.2, t); g3.gain.linearRampToValueAtTime(0, t + 0.24);
                    osc3.connect(g3); g3.connect(comp); osc3.start(t); osc3.stop(t + 0.25);

                    i++;
                    if (i < 4) alarmaTimeout = setTimeout(chirp, 280);
                    else alarmaTimeout = setTimeout(cb, 350);
                }
                chirp();
            }

            function faseB(cb) {
                if (!alarmaRunning) return;
                const t = ctx.currentTime; const dur = 1.4;
                const osc = ctx.createOscillator(); const g = ctx.createGain();
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(600, t);
                osc.frequency.linearRampToValueAtTime(1300, t + dur / 2);
                osc.frequency.linearRampToValueAtTime(600, t + dur);
                g.gain.setValueAtTime(0, t); g.gain.linearRampToValueAtTime(0.7, t + 0.05);
                g.gain.setValueAtTime(0.7, t + dur - 0.05); g.gain.linearRampToValueAtTime(0, t + dur);
                osc.connect(g); g.connect(comp); osc.start(t); osc.stop(t + dur);
                const osc2 = ctx.createOscillator(); const g2 = ctx.createGain();
                osc2.type = 'square';
                osc2.frequency.setValueAtTime(1200, t);
                osc2.frequency.linearRampToValueAtTime(2600, t + dur / 2);
                osc2.frequency.linearRampToValueAtTime(1200, t + dur);
                g2.gain.setValueAtTime(0.2, t); g2.gain.linearRampToValueAtTime(0, t + dur);
                osc2.connect(g2); g2.connect(comp); osc2.start(t); osc2.stop(t + dur);
                alarmaTimeout = setTimeout(cb, dur * 1000 + 100);
            }

            function faseC(cb) {
                let i = 0;
                function beep() {
                    if (!alarmaRunning) return;
                    const t = ctx.currentTime;
                    const osc = ctx.createOscillator(); const g = ctx.createGain();
                    osc.type = 'square'; osc.frequency.value = 1100;
                    g.gain.setValueAtTime(0.6, t);
                    g.gain.exponentialRampToValueAtTime(0.001, t + 0.1);
                    osc.connect(g); g.connect(comp); osc.start(t); osc.stop(t + 0.11);
                    i++;
                    if (i < 4) alarmaTimeout = setTimeout(beep, 160);
                    else alarmaTimeout = setTimeout(cb, 300);
                }
                beep();
            }

            function ciclo() {
                if (!alarmaRunning) return;
                faseA(() => faseB(() => faseC(() => { alarmaTimeout = setTimeout(ciclo, 200); })));
            }
            ciclo();
            iniciarVibracion();
        }

        function pararAlarma() {
            alarmaRunning = false;
            if (alarmaTimeout) { clearTimeout(alarmaTimeout); alarmaTimeout = null; }
            pararVibracion();
        }

        // =============================================
        // VIBRACI√ìN ‚Äî robusta para Android Chrome
        // =============================================
        // =============================================
        // L√ìGICA PRINCIPAL
        // =============================================
        window.iniciarSesion = function() {
            BUZON_SECRETO = document.getElementById('inputContrasena').value.trim();
            if (BUZON_SECRETO === "") return alert("Introduce una contrase√±a.");
            getAudioCtx();

            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-screen').style.display = 'flex';

            onSnapshot(doc(db, "dispositivos", BUZON_SECRETO), (documento) => {
                if (documento.exists() && vigilando) {
                    let cmd = documento.data().comando;
                    if (cmd === "apagar")         { window.detenerVigilancia(); setDoc(doc(db, "dispositivos", BUZON_SECRETO), { comando: "" }, { merge: true }); }
                    else if (cmd === "silenciar") { window.silenciarAlarma();   setDoc(doc(db, "dispositivos", BUZON_SECRETO), { comando: "" }, { merge: true }); }
                }
            });
        };

        function obtenerModo() { return document.querySelector('input[name="modoVigilancia"]:checked').value; }

        function enviarDatos() {
            if (!BUZON_SECRETO) return;
            setDoc(doc(db, "dispositivos", BUZON_SECRETO), { latitud: latActual, longitud: lonActual, nivelAlarma, modo: obtenerModo(), tiempo: Date.now(), activo: vigilando }, { merge: true });
        }

        async function mantenerPantallaEncendida() { try { if ('wakeLock' in navigator) wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {} }

        window.apagarPantalla  = function() { document.getElementById('pantalla-negra').style.display = 'flex'; };
        window.toqueDesbloqueo = function() {
            toquesDesbloqueo++;
            if (toquesDesbloqueo >= 3) { document.getElementById('pantalla-negra').style.display = 'none'; toquesDesbloqueo = 0; }
            setTimeout(() => { toquesDesbloqueo = 0; }, 2000);
        };

        window.iniciarVigilancia = function() {
            getAudioCtx();
            if (navigator.geolocation) navigator.geolocation.getCurrentPosition(()=>{}, ()=>{}, {enableHighAccuracy: true});
            if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                DeviceMotionEvent.requestPermission().then(e => { if (e === 'granted') activarSensores(); });
            } else { activarSensores(); }
        };

        function activarSensores() {
            vigilando = true; nivelAlarma = 0;
            document.getElementById('selector-modos').style.display = "none";
            document.getElementById('estado').innerText = "üü¢ VIGILANCIA ACTIVA";
            document.getElementById('btnActivar').style.display  = "none";
            document.getElementById('btnSimular').style.display  = "block";
            document.getElementById('btnPantalla').style.display = "block";
            document.getElementById('btnDetener').style.display  = "block";
            mantenerPantallaEncendida(); enviarDatos();
            window.addEventListener('devicemotion', detectarGolpe);
        }

        window.simularMovimiento = function() {
            if (vigilando) procesarMovimiento(true);
        };

        function detectarGolpe(evento) {
            if (!vigilando || nivelAlarma === 2) return;
            let acc = evento.accelerationIncludingGravity || evento.acceleration;
            if (!acc || acc.x === null) return;
            if (lastX !== null) {
                let diff = Math.abs(acc.x - lastX) + Math.abs(acc.y - lastY) + Math.abs(acc.z - lastZ);
                if (diff > 10) procesarMovimiento(false);
            }
            lastX = acc.x; lastY = acc.y; lastZ = acc.z;
        }

        function procesarMovimiento(forzar) {
            let ahora = Date.now();
            let modo = obtenerModo();
            if (modo === "normal") {
                if (nivelAlarma === 0) {
                    nivelAlarma = 1; tiempoUltimoAviso = ahora;
                    document.body.className = 'alerta-amarilla';
                    document.getElementById('estado').innerText = "üü° MOVIMIENTO DETECTADO";
                    enviarDatos();
                    if (temporizadorNormal) clearTimeout(temporizadorNormal);
                    temporizadorNormal = setTimeout(() => {
                        if (nivelAlarma === 1) { nivelAlarma = 0; document.body.className = ''; document.getElementById('estado').innerText = "üü¢ VIGILANCIA ACTIVA"; enviarDatos(); }
                    }, 30000);
                } else if (nivelAlarma === 1 && (forzar || ahora - tiempoUltimoAviso > 2000)) {
                    nivelAlarma = 2; if (temporizadorNormal) clearTimeout(temporizadorNormal); dispararAlarmaSilenciosa();
                }
            } else if (modo === "seguro") {
                if (nivelAlarma === 0) {
                    nivelAlarma = 1; tiempoUltimoAviso = ahora;
                    playAviso();
                    document.body.className = 'alerta-amarilla';
                    document.getElementById('estado').innerText = "üü° ADVERTENCIA SONORA";
                    enviarDatos();
                    if (temporizadorNormal) clearTimeout(temporizadorNormal);
                    temporizadorNormal = setTimeout(() => {
                        if (nivelAlarma === 1) { nivelAlarma = 0; document.body.className = ''; document.getElementById('estado').innerText = "üü¢ VIGILANCIA ACTIVA"; enviarDatos(); }
                    }, 30000);
                } else if (nivelAlarma === 1 && (forzar || ahora - tiempoUltimoAviso > 2000)) {
                    nivelAlarma = 2; if (temporizadorNormal) clearTimeout(temporizadorNormal); dispararAlarmaGeneral();
                }
            }
        }

        function dispararAlarmaSilenciosa() {
            document.body.className = 'alerta-roja';
            document.getElementById('estado').innerText = "üî¥ ROBO SILENCIOSO";
            iniciarRastreoGPS(); enviarDatos();
        }

        function dispararAlarmaGeneral() {
            document.body.className = 'alerta-roja';
            document.getElementById('estado').innerText = "üî¥ SIRENA ACTIVADA";
            iniciarAlarma();
            iniciarRastreoGPS(); enviarDatos();
        }

        window.silenciarAlarma = function() {
            nivelAlarma = 0; if (temporizadorNormal) clearTimeout(temporizadorNormal);
            pararAlarma();
            if (gpsTracker !== null) { navigator.geolocation.clearWatch(gpsTracker); gpsTracker = null; }
            document.getElementById('coordenadas').innerText = "GPS: En reposo";
            document.body.className = ''; document.getElementById('estado').innerText = "üü¢ VIGILANCIA ACTIVA"; enviarDatos();
        };

        window.detenerVigilancia = function() {
            vigilando = false; nivelAlarma = 0; if (temporizadorNormal) clearTimeout(temporizadorNormal);
            pararAlarma();
            window.removeEventListener('devicemotion', detectarGolpe);
            if (gpsTracker !== null) { navigator.geolocation.clearWatch(gpsTracker); gpsTracker = null; }
            if (wakeLock !== null) { wakeLock.release(); wakeLock = null; }
            document.getElementById('pantalla-negra').style.display = 'none';
            document.body.className = ''; document.getElementById('estado').innerText = "‚ö™ SISTEMA APAGADO";
            document.getElementById('coordenadas').innerText = "GPS: Apagado";
            document.getElementById('btnSimular').style.display  = "none";
            document.getElementById('btnPantalla').style.display = "none";
            document.getElementById('btnDetener').style.display  = "none";
            document.getElementById('selector-modos').style.display = "block";
            document.getElementById('btnActivar').style.display  = "block";
            enviarDatos();
        };

        function iniciarRastreoGPS() {
            document.getElementById('coordenadas').innerText = "üìç Activando GPS...";
            if (navigator.geolocation) {
                gpsTracker = navigator.geolocation.watchPosition(
                    (pos) => { latActual = pos.coords.latitude; lonActual = pos.coords.longitude; document.getElementById('coordenadas').innerText = `üìç Pos: ${latActual.toFixed(5)}, ${lonActual.toFixed(5)}`; enviarDatos(); },
                    ()    => { document.getElementById('coordenadas').innerText = "‚ùå Error GPS"; },
                    { enableHighAccuracy: true, maximumAge: 3000, timeout: 8000 }
                );
            }
        }
    </script>
</body>
</html>
