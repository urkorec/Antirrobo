<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor - Escudo Irun</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { margin: 0; padding: 0; font-family: 'Poppins', sans-serif; background-color: #0f172a;}
        #login-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10000; background: #0f172a; color: white;}
        .box { background: rgba(255, 255, 255, 0.05); padding: 40px; border-radius: 20px; text-align: center; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 10px 30px rgba(0,0,0,0.5); width: 80%; max-width: 350px;}
        .box h2 { margin-top: 0; color: #4facfe; font-weight: 800;}
        .input-pass { padding: 15px; font-size: 16px; border-radius: 12px; border: none; margin-bottom: 20px; width: 90%; text-align: center; font-family: 'Poppins'; }
        .btn-login { background: linear-gradient(45deg, #4facfe, #00f2fe); color: white; padding: 15px; font-size: 16px; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; width: 100%; transition: transform 0.2s; }
        
        #app-screen { display: none; height: 100vh; width: 100vw; position: relative;}
        #mapa { height: 100%; width: 100%; z-index: 1;}
        
        #panel-info { position: absolute; top: 15px; left: 50%; transform: translateX(-50%); z-index: 1000; background: rgba(25, 30, 45, 0.9); backdrop-filter: blur(10px); padding: 12px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.1); text-align: center; width: 85%; max-width: 320px; color: white; }
        h3 { margin: 0 0 5px 0; font-weight: 800; font-size: 14px; color: #fff; }
        .modo-badge { display: inline-block; background: rgba(255,255,255,0.1); color: #ccc; padding: 3px 8px; border-radius: 8px; font-size: 10px; margin-bottom: 5px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px;}
        #estado-tracker { font-size: 12px; margin-bottom: 8px; font-weight: 600; padding: 6px; border-radius: 6px; background: rgba(0,0,0,0.3);}
        
        #alerta { background: linear-gradient(45deg, #cb2d3e, #ef473a); color: white; padding: 8px; border-radius: 8px; font-weight: 800; font-size: 14px; display: none; animation: latido 0.4s infinite alternate; margin-bottom: 8px; box-shadow: 0 0 10px rgba(255,0,0,0.5); }
        @keyframes latido { from { transform: scale(1); } to { transform: scale(1.02); } }

        .botones-container { display: flex; gap: 8px; justify-content: space-between; display: none; }
        .btn-remoto { flex: 1; background: rgba(255,255,255,0.1); color: #ff4d4d; border: 1px solid #ff4d4d; padding: 8px; border-radius: 8px; font-size: 11px; font-weight: 600; cursor: pointer;}
        .btn-silenciar { flex: 1; background: linear-gradient(45deg, #f12711, #f5af19); color: white; border: none; padding: 8px; border-radius: 8px; font-size: 11px; font-weight: 800; cursor: pointer; text-transform: uppercase;}
        .btn-maps { width: 100%; background: linear-gradient(45deg, #1a73e8, #0d47a1); color: white; border: none; padding: 8px; border-radius: 8px; font-size: 11px; font-weight: 700; cursor: pointer; margin-top: 8px; display: none; }

        #btn-centrar { position: absolute; bottom: 90px; right: 15px; z-index: 1000; width: 44px; height: 44px; border-radius: 50%; border: none; cursor: pointer; font-size: 20px; display: none; box-shadow: 0 3px 10px rgba(0,0,0,0.4); transition: background 0.2s, transform 0.15s; }
        #btn-centrar.activo   { background: #4facfe; }
        #btn-centrar.inactivo { background: rgba(40,50,70,0.92); border: 2px solid rgba(255,255,255,0.25); }
        #btn-centrar:active   { transform: scale(0.9); }
    </style>
</head>
<body>
    <div id="login-screen">
        <div class="box">
            <h2>üåç Monitor Radar</h2>
            <p>Rastreo y Control Remoto</p>
            <input type="password" id="inputContrasena" class="input-pass" placeholder="Contrase√±a secreta">
            <button class="btn-login" onclick="iniciarSesion()">Conectar Radar</button>
        </div>
    </div>

    <div id="app-screen">
        <div id="panel-info">
            <h3>üõ∞Ô∏è Radar de Seguridad</h3>
            <div id="modo-texto" class="modo-badge">Esperando se√±al...</div>
            <div id="estado-tracker">Conectando...</div>
            <div id="alerta">¬°ROBO DETECTADO!</div>
            
            <div class="botones-container" id="cajaBotones">
                <button id="btnSilenciarRemoto" class="btn-silenciar" onclick="silenciarRemoto()">üîï Silenciar</button>
                <button id="btnApagarRemoto" class="btn-remoto" onclick="apagarRemoto()">üõë Apagar</button>
            </div>
            <button id="btnMaps" class="btn-maps" onclick="abrirEnMaps()">üó∫Ô∏è Abrir en Google Maps</button>
        </div>
        <button id="btn-centrar" class="activo" onclick="activarCentrado()">üìç</button>
        <div id="mapa"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCtStv8wmlLNOhiw0lnc9mzVlQwLXrYdbY",
            authDomain: "antirrobo-457ef.firebaseapp.com",
            projectId: "antirrobo-457ef"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // =============================================
        // TELEGRAM ‚Äî pon aqu√≠ tu token y chat_id
        // =============================================
        const TELEGRAM_TOKEN  = "8565258420:AAHB5CHbTJChcFvyW5FMiZ2Jl_tpnSDM8Ho";   // ej: 7123456789:AAFxxxxxx
        const TELEGRAM_CHAT_ID = "1156363611"; // ej: 123456789

        let telegramEnviado = false; // evita enviar spam si el nivel 2 persiste

        async function enviarTelegram(mensaje) {
            if (telegramEnviado) return;
            telegramEnviado = true;
            try {
                await fetch(`https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ chat_id: TELEGRAM_CHAT_ID, text: mensaje })
                });
            } catch(e) {
                console.error("Error enviando Telegram:", e);
            }
        }
        // =============================================

        let BUZON_SECRETO = "";
        let mapa, marcador;
        let centradoActivo = true;
        let ultimaPosicion = null;
        let ultimaUbicacionTs = 0;

        function activarCentrado() {
            centradoActivo = true;
            const btn = document.getElementById('btn-centrar');
            btn.classList.replace('inactivo', 'activo');
            if (ultimaPosicion) mapa.setView(ultimaPosicion, 17, {animate: true, duration: 0.8});
        }
        window.activarCentrado = activarCentrado;

        // =============================================
        // VIBRACI√ìN ‚Äî robusta para Android Chrome
        // =============================================
        let alarmaRunning = false;
        let vibLoop = null;

        function vibPreload() {
            if ("vibrate" in navigator) navigator.vibrate(1);
        }

        function iniciarAlarma() {
            if (alarmaRunning) return;
            alarmaRunning = true;
            _vibTick();
        }

        function _vibTick() {
            if (!alarmaRunning) return;
            if ("vibrate" in navigator) navigator.vibrate(900);
            vibLoop = setTimeout(_vibTick, 1100);
        }

        function pararAlarma() {
            alarmaRunning = false;
            if (vibLoop) { clearTimeout(vibLoop); vibLoop = null; }
            if ("vibrate" in navigator) navigator.vibrate(0);
        }

        window.iniciarSesion = function() {
            BUZON_SECRETO = document.getElementById('inputContrasena').value.trim();
            if (BUZON_SECRETO === "") return alert("La contrase√±a es obligatoria.");
            vibPreload();
            
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-screen').style.display = 'block';

            mapa = L.map('mapa', {zoomControl: false}).setView([43.3390, -1.7896], 16);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: '¬© CartoDB' }).addTo(mapa);
            marcador = L.marker([43.3390, -1.7896]).addTo(mapa);
            L.control.zoom({ position: 'bottomright' }).addTo(mapa);

            document.getElementById('btn-centrar').style.display = 'block';
            mapa.on('dragstart', () => {
                centradoActivo = false;
                const btn = document.getElementById('btn-centrar');
                btn.classList.replace('activo', 'inactivo');
            });

            onSnapshot(doc(db, "dispositivos", BUZON_SECRETO), (documento) => {
                if (documento.exists()) {
                    let datos = documento.data();
                    let nuevaPosicion = new L.LatLng(datos.latitud, datos.longitud);
                    ultimaPosicion = nuevaPosicion;
                    if (datos.ubicacionActualizada) ultimaUbicacionTs = datos.ubicacionActualizada;
                    marcador.setLatLng(nuevaPosicion);
                    if (centradoActivo) mapa.setView(nuevaPosicion, 17, {animate: true, duration: 0.8});

                    let modoDiv    = document.getElementById('modo-texto');
                    let estadoDiv  = document.getElementById('estado-tracker');
                    let alertaDiv  = document.getElementById('alerta');
                    let cajaBotones = document.getElementById('cajaBotones');
                    let btnSilenciar = document.getElementById('btnSilenciarRemoto');

                    if(datos.modo === "normal") modoDiv.innerHTML = "üîµ Sigilo";
                    else if(datos.modo === "seguro") modoDiv.innerHTML = "üî¥ Alarma";

                    // El bot√≥n Maps se muestra siempre que haya posici√≥n, pase lo que pase
                    document.getElementById('btnMaps').style.display = 'block';

                    if (!datos.activo) {
                        estadoDiv.innerHTML = "‚ö™ Apagado";
                        estadoDiv.style.color = "#888";
                        alertaDiv.style.display = 'none';
                        cajaBotones.style.display = 'none';
                        pararAlarma();
                    } else {
                        cajaBotones.style.display = 'flex'; 

                        if (datos.nivelAlarma === 0) {
                            estadoDiv.innerHTML = "üü¢ Vigilando";
                            estadoDiv.style.color = "#4ade80";
                            alertaDiv.style.display = 'none';
                            btnSilenciar.style.display = 'none';
                            pararAlarma();
                            telegramEnviado = false; // resetear para el pr√≥ximo evento
                        
                        } else if (datos.nivelAlarma === 1) {
                            alertaDiv.style.display = 'none';
                            btnSilenciar.style.display = 'block'; 
                            pararAlarma();
                            
                            if (datos.modo === "normal") estadoDiv.innerHTML = "üü° Movimiento Detectado";
                            else if (datos.modo === "seguro") estadoDiv.innerHTML = "üü° Emitiendo Advertencia";
                            estadoDiv.style.color = "#facc15";

                        } else if (datos.nivelAlarma === 2) {
                            alertaDiv.style.display = 'block';
                            btnSilenciar.style.display = 'block'; 
                            iniciarAlarma();

                            if (datos.modo === "normal") {
                                estadoDiv.innerHTML = "üî¥ ROBO EN CURSO";
                                alertaDiv.innerHTML = "¬°BICI EN MOVIMIENTO!";
                                // Incluir coordenadas en el mensaje de Telegram
                                const mapsUrl = `https://maps.google.com/?q=${datos.latitud},${datos.longitud}`;
                                enviarTelegram(`üö® ¬°ALERTA! Bici en movimiento detectada.\nüìç Ubicaci√≥n: ${mapsUrl}`);
                            } else {
                                estadoDiv.innerHTML = "üî¥ ALARMA SONANDO";
                                alertaDiv.innerHTML = "¬°ROBO DETECTADO!";
                                const mapsUrl = `https://maps.google.com/?q=${datos.latitud},${datos.longitud}`;
                                enviarTelegram(`üö® ¬°ALERTA! Robo detectado. Alarma sonando.\nüìç Ubicaci√≥n: ${mapsUrl}`);
                            }
                            estadoDiv.style.color = "#f87171";
                        }
                    }
                }
            });
        };

        window.abrirEnMaps = function() {
            if (!BUZON_SECRETO) return;
            const btn = document.getElementById('btnMaps');
            btn.disabled = true;
            btn.textContent = '‚è≥ Obteniendo ubicaci√≥n...';

            // Enviar comando al emisor
            setDoc(doc(db, "dispositivos", BUZON_SECRETO), { comando: "ubicacion" }, { merge: true });

            // Esperar a que el emisor actualice ubicacionActualizada en Firebase (m√°x 12s)
            const inicio = Date.now();
            const tsAntes = ultimaUbicacionTs;

            const intervalo = setInterval(() => {
                // La posici√≥n se actualiza via onSnapshot; comprobamos si cambi√≥ el timestamp
                if (ultimaUbicacionTs !== tsAntes) {
                    clearInterval(intervalo);
                    btn.disabled = false;
                    btn.textContent = 'üó∫Ô∏è Abrir en Google Maps';
                    window.open(`https://maps.google.com/?q=${ultimaPosicion.lat},${ultimaPosicion.lng}`, '_blank');
                } else if (Date.now() - inicio > 12000) {
                    clearInterval(intervalo);
                    btn.disabled = false;
                    btn.textContent = 'üó∫Ô∏è Abrir en Google Maps';
                    // Si no respondi√≥, abrir con la √∫ltima posici√≥n conocida
                    if (ultimaPosicion) window.open(`https://maps.google.com/?q=${ultimaPosicion.lat},${ultimaPosicion.lng}`, '_blank');
                    else alert("El emisor no respondi√≥. Comprueba que est√° activo.");
                }
            }, 500);
        }

        window.apagarRemoto = function() {
            if(!BUZON_SECRETO) return;
            vibPreload();
            setDoc(doc(db, "dispositivos", BUZON_SECRETO), { comando: "apagar" }, { merge: true });
        }

        window.silenciarRemoto = function() {
            if(!BUZON_SECRETO) return;
            vibPreload();
            setDoc(doc(db, "dispositivos", BUZON_SECRETO), { comando: "silenciar" }, { merge: true });
            pararAlarma();
        }
    </script>
</body>
</html>
