<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor - Escudo Irun</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { margin: 0; padding: 0; font-family: 'Poppins', sans-serif; background-color: #0f172a;}
        #login-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10000; background: #0f172a; color: white;}
        .box { background: rgba(255, 255, 255, 0.05); padding: 40px; border-radius: 20px; text-align: center; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 10px 30px rgba(0,0,0,0.5); width: 80%; max-width: 350px;}
        .box h2 { margin-top: 0; color: #4facfe; font-weight: 800;}
        .input-pass { padding: 15px; font-size: 16px; border-radius: 12px; border: none; margin-bottom: 20px; width: 90%; text-align: center; font-family: 'Poppins'; }
        .btn-login { background: linear-gradient(45deg, #4facfe, #00f2fe); color: white; padding: 15px; font-size: 16px; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; width: 100%; transition: transform 0.2s; }
        
        #app-screen { display: none; height: 100vh; width: 100vw; position: relative;}
        #mapa { height: 100%; width: 100%; z-index: 1;}
        
        #panel-info { position: absolute; top: 15px; left: 50%; transform: translateX(-50%); z-index: 1000; background: rgba(25, 30, 45, 0.9); backdrop-filter: blur(10px); padding: 12px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.1); text-align: center; width: 85%; max-width: 320px; color: white; }
        h3 { margin: 0 0 5px 0; font-weight: 800; font-size: 14px; color: #fff; }
        .modo-badge { display: inline-block; background: rgba(255,255,255,0.1); color: #ccc; padding: 3px 8px; border-radius: 8px; font-size: 10px; margin-bottom: 5px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px;}
        #estado-tracker { font-size: 12px; margin-bottom: 8px; font-weight: 600; padding: 6px; border-radius: 6px; background: rgba(0,0,0,0.3);}
        
        #alerta { background: linear-gradient(45deg, #cb2d3e, #ef473a); color: white; padding: 8px; border-radius: 8px; font-weight: 800; font-size: 14px; display: none; animation: latido 0.4s infinite alternate; margin-bottom: 8px; box-shadow: 0 0 10px rgba(255,0,0,0.5); }
        @keyframes latido { from { transform: scale(1); } to { transform: scale(1.02); } }

        .botones-container { display: flex; gap: 8px; justify-content: space-between; display: none; }
        .btn-remoto { flex: 1; background: rgba(255,255,255,0.1); color: #ff4d4d; border: 1px solid #ff4d4d; padding: 8px; border-radius: 8px; font-size: 11px; font-weight: 600; cursor: pointer;}
        .btn-silenciar { flex: 1; background: linear-gradient(45deg, #f12711, #f5af19); color: white; border: none; padding: 8px; border-radius: 8px; font-size: 11px; font-weight: 800; cursor: pointer; text-transform: uppercase;}
    </style>
</head>
<body>
    <div id="login-screen">
        <div class="box">
            <h2>üåç Monitor Radar</h2>
            <p>Rastreo y Control Remoto</p>
            <input type="password" id="inputContrasena" class="input-pass" placeholder="Contrase√±a secreta">
            <button class="btn-login" onclick="iniciarSesion()">Conectar Radar</button>
        </div>
    </div>

    <div id="app-screen">
        <div id="panel-info">
            <h3>üõ∞Ô∏è Radar de Seguridad</h3>
            <div id="modo-texto" class="modo-badge">Esperando se√±al...</div>
            <div id="estado-tracker">Conectando...</div>
            <div id="alerta">¬°ROBO DETECTADO!</div>
            
            <div class="botones-container" id="cajaBotones">
                <button id="btnSilenciarRemoto" class="btn-silenciar" onclick="silenciarRemoto()">üîï Silenciar</button>
                <button id="btnApagarRemoto" class="btn-remoto" onclick="apagarRemoto()">üõë Apagar</button>
            </div>
        </div>
        <div id="mapa"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCtStv8wmlLNOhiw0lnc9mzVlQwLXrYdbY",
            authDomain: "antirrobo-457ef.firebaseapp.com",
            projectId: "antirrobo-457ef"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let BUZON_SECRETO = "";
        let mapa, marcador;
        let sonidoMonitor = new Audio('https://actions.google.com/sounds/v1/alarms/beeping_alarm.ogg');
        sonidoMonitor.loop = true;

        // Funci√≥n maestra para desbloquear el audio en navegadores estrictos
        function desbloquearAudio(audioObj) {
            audioObj.muted = true;
            audioObj.play().then(() => {
                audioObj.pause();
                audioObj.muted = false;
                audioObj.currentTime = 0;
            }).catch(e => console.log("Esperando permiso de audio...", e));
        }

        window.iniciarSesion = function() {
            BUZON_SECRETO = document.getElementById('inputContrasena').value.trim();
            if (BUZON_SECRETO === "") return alert("La contrase√±a es obligatoria.");
            
            // Desbloqueamos el audio del radar en el clic del usuario
            desbloquearAudio(sonidoMonitor);

            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-screen').style.display = 'block';

            mapa = L.map('mapa', {zoomControl: false}).setView([43.3390, -1.7896], 16);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: '¬© CartoDB' }).addTo(mapa);
            marcador = L.marker([43.3390, -1.7896]).addTo(mapa);
            L.control.zoom({ position: 'bottomright' }).addTo(mapa);

            onSnapshot(doc(db, "dispositivos", BUZON_SECRETO), (documento) => {
                if (documento.exists()) {
                    let datos = documento.data();
                    let nuevaPosicion = new L.LatLng(datos.latitud, datos.longitud);
                    marcador.setLatLng(nuevaPosicion);
                    mapa.setView(nuevaPosicion, 17, {animate: true, duration: 0.8});

                    let modoDiv = document.getElementById('modo-texto');
                    let estadoDiv = document.getElementById('estado-tracker');
                    let alertaDiv = document.getElementById('alerta');
                    let cajaBotones = document.getElementById('cajaBotones');
                    let btnSilenciar = document.getElementById('btnSilenciarRemoto');

                    if(datos.modo === "normal") modoDiv.innerHTML = "üîµ Sigilo";
                    else if(datos.modo === "seguro") modoDiv.innerHTML = "üî¥ Alarma";

                    if (!datos.activo) {
                        estadoDiv.innerHTML = "‚ö™ Apagado";
                        estadoDiv.style.color = "#888";
                        alertaDiv.style.display = 'none';
                        cajaBotones.style.display = 'none'; 
                        sonidoMonitor.pause();
                    } else {
                        cajaBotones.style.display = 'flex'; 

                        if (datos.nivelAlarma === 0) {
                            estadoDiv.innerHTML = "üü¢ Vigilando";
                            estadoDiv.style.color = "#4ade80";
                            alertaDiv.style.display = 'none';
                            btnSilenciar.style.display = 'none';
                            sonidoMonitor.pause();
                        
                        } else if (datos.nivelAlarma === 1) {
                            alertaDiv.style.display = 'none';
                            btnSilenciar.style.display = 'block'; 
                            sonidoMonitor.pause();
                            
                            if (datos.modo === "normal") estadoDiv.innerHTML = "üü° Movimiento Detectado";
                            else if (datos.modo === "seguro") estadoDiv.innerHTML = "üü° Emitiendo Advertencia";
                            estadoDiv.style.color = "#facc15";

                        } else if (datos.nivelAlarma === 2) {
                            alertaDiv.style.display = 'block';
                            btnSilenciar.style.display = 'block'; 
                            
                            // El audio ya fue desbloqueado, as√≠ que deber√≠a sonar sin problemas
                            sonidoMonitor.play().catch(e => console.log(e));
                            if ("vibrate" in navigator) navigator.vibrate([1000, 500, 1000, 500, 1000]);
                            
                            if (datos.modo === "normal") {
                                estadoDiv.innerHTML = "üî¥ ROBO EN CURSO";
                                alertaDiv.innerHTML = "¬°BICI EN MOVIMIENTO!";
                            } else {
                                estadoDiv.innerHTML = "üî¥ ALARMA SONANDO";
                                alertaDiv.innerHTML = "¬°ROBO DETECTADO!";
                            }
                            estadoDiv.style.color = "#f87171";
                        }
                    }
                }
            });
        };

        window.apagarRemoto = function() {
            if(!BUZON_SECRETO) return;
            setDoc(doc(db, "dispositivos", BUZON_SECRETO), { comando: "apagar" }, { merge: true });
        }

        window.silenciarRemoto = function() {
            if(!BUZON_SECRETO) return;
            setDoc(doc(db, "dispositivos", BUZON_SECRETO), { comando: "silenciar" }, { merge: true });
            sonidoMonitor.pause();
        }
    </script>
</body>
</html>
