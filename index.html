<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dispositivo Vigilante</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            text-align: center; 
            padding: 50px; 
            background-color: #f4f4f4;
            transition: background 0.2s; 
        }
        .btn { 
            padding: 20px 40px; 
            font-size: 22px; 
            background-color: #4CAF50; 
            color: white; 
            border: none; 
            border-radius: 10px; 
            cursor: pointer; 
            box-shadow: 0px 4px 6px rgba(0,0,0,0.2);
        }
        #estado { 
            margin-top: 30px; 
            font-size: 24px; 
            font-weight: bold; 
            color: #333;
        }
        #coordenadas {
            margin-top: 15px;
            font-size: 18px;
            color: #444;
            font-weight: bold;
        }
        /* Clase para la Fase 1: Aviso */
        .alerta-amarilla {
            background-color: #ffcc00 !important;
        }
        /* Clase para la Fase 2: Alarma Total */
        .alerta-roja {
            background-color: #ff0000 !important;
            color: white !important;
            animation: parpadeo 0.3s infinite;
        }
        @keyframes parpadeo {
            0% { background-color: #ff0000; }
            50% { background-color: #8b0000; }
            100% { background-color: #ff0000; }
        }
    </style>
</head>
<body>

    <h1>üö® Sensor Antirrobo</h1>
    <button class="btn" id="btnActivar" onclick="iniciarVigilancia()">1. Activar Vigilancia</button>
    <p id="estado">Estado: Apagado</p>
    <p id="coordenadas">GPS: Apagado (Ahorrando bater√≠a)</p>

    <script>
        let vigilando = false;
        let nivelAlarma = 0; // 0: Normal, 1: Aviso (Bip), 2: Alarma Total
        let tiempoUltimoAviso = 0;
        
        // Sonidos oficiales de Google (gratuitos)
        let sonidoAviso = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');
        let sonidoAlarma = new Audio('https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg');
        sonidoAlarma.loop = true; // La alarma final sonar√° en bucle

        // Variables de movimiento
        let lastX = null, lastY = null, lastZ = null;

        function iniciarVigilancia() {
            // Truco para que el navegador nos deje reproducir audio despu√©s sin que el usuario pulse nada
            sonidoAviso.play().then(() => sonidoAviso.pause()).catch(e => console.log("Audio en espera"));
            sonidoAlarma.play().then(() => sonidoAlarma.pause()).catch(e => console.log("Audio en espera"));

            // Permisos de sensores (Obligatorio en iOS)
            if (typeof DeviceMotionEvent.requestPermission === 'function') {
                DeviceMotionEvent.requestPermission().then(permissionState => {
                    if (permissionState === 'granted') activarSensores();
                    else alert("Necesitas dar permiso de sensores.");
                }).catch(console.error);
            } else {
                activarSensores(); // En Android entra directo
            }
        }

        function activarSensores() {
            vigilando = true;
            document.getElementById('estado').innerText = "üü¢ Vigilando... ¬°No lo muevas!";
            document.getElementById('btnActivar').style.display = "none";
            
            window.addEventListener('devicemotion', (evento) => {
                if (!vigilando || nivelAlarma === 2) return; // Si ya est√° sonando la alarma final, dejamos de calcular

                let acc = evento.accelerationIncludingGravity;
                if (!acc) return;

                let x = acc.x; let y = acc.y; let z = acc.z;

                if (lastX !== null) {
                    let diffX = Math.abs(x - lastX);
                    let diffY = Math.abs(y - lastY);
                    let diffZ = Math.abs(z - lastZ);
                    
                    let movimientoTotal = diffX + diffY + diffZ;

                    // Si detecta un golpe o sacudida fuerte
                    if (movimientoTotal > 12) {
                        procesarMovimiento();
                    }
                }
                lastX = x; lastY = y; lastZ = z;
            });
        }

        function procesarMovimiento() {
            let ahora = Date.now();

            if (nivelAlarma === 0) {
                // FASE 1: PRIMER MOVIMIENTO DETECTADO
                nivelAlarma = 1;
                tiempoUltimoAviso = ahora;
                
                sonidoAviso.play(); // Suena el Bip!
                document.body.classList.add('alerta-amarilla');
                document.getElementById('estado').innerText = "‚ö†Ô∏è ¬°ADVERTENCIA! Se ha detectado movimiento";
                
                // En este momento exacto, encendemos el rastreo GPS continuo
                iniciarRastreoGPS();

            } else if (nivelAlarma === 1) {
                // FASE 2: SEGUNDO MOVIMIENTO DETECTADO
                // Esperamos al menos 1.5 segundos desde el aviso para no disparar la alarma con el mismo golpe inicial
                if (ahora - tiempoUltimoAviso > 1500) {
                    dispararAlarmaFinal();
                }
            }
        }

        function iniciarRastreoGPS() {
            document.getElementById('coordenadas').innerText = "üìç GPS: Obteniendo ubicaci√≥n...";
            
            if (navigator.geolocation) {
                // watchPosition actualiza constantemente cada vez que el m√≥vil cambia de coordenadas
                navigator.geolocation.watchPosition(actualizarUbicacion, errorGPS, {
                    enableHighAccuracy: true,
                    maximumAge: 0
                });
            }
        }

        function dispararAlarmaFinal() {
            nivelAlarma = 2;
            
            // Efectos visuales y sonoros
            document.body.classList.remove('alerta-amarilla');
            document.body.classList.add('alerta-roja');
            document.getElementById('estado').innerText = "üî¥ ¬°ALERTA! ¬°ROBO CONFIRMADO!";
            
            sonidoAlarma.volume = 1.0; // Volumen al m√°ximo
            sonidoAlarma.play(); // Suena la alarma en bucle
        }

        function actualizarUbicacion(posicion) {
            let lat = posicion.coords.latitude;
            let lon = posicion.coords.longitude;
            document.getElementById('coordenadas').innerText = `üìç Actualizando GPS: ${lat.toFixed(5)}, ${lon.toFixed(5)}`;
            
            // Aqu√≠ ser√° donde enviaremos las coordenadas actualizadas a Firebase
        }

        function errorGPS(error) {
            document.getElementById('coordenadas').innerText = "GPS: Error de se√±al";
        }
    </script>
</body>
</html>
