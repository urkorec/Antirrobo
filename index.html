<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dispositivo Vigilante - V2</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            text-align: center; 
            padding: 20px; 
            background-color: #f4f4f4;
            transition: background 0.2s; 
        }
        .btn { 
            padding: 20px 30px; 
            font-size: 20px; 
            background-color: #4CAF50; 
            color: white; 
            border: none; 
            border-radius: 10px; 
            cursor: pointer; 
            margin: 10px;
            box-shadow: 0px 4px 6px rgba(0,0,0,0.2);
        }
        .btn-test {
            background-color: #555;
            font-size: 16px;
            padding: 15px 20px;
            display: none; /* Se mostrar√° cuando se active la vigilancia */
        }
        #estado { 
            margin-top: 30px; 
            font-size: 22px; 
            font-weight: bold; 
            color: #333;
            padding: 20px;
            border-radius: 10px;
        }
        #coordenadas {
            margin-top: 15px;
            font-size: 16px;
            color: #444;
            background: #fff;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        /* Fases de Alarma */
        .alerta-amarilla { background-color: #ffcc00 !important; }
        .alerta-roja {
            background-color: #ff0000 !important;
            color: white !important;
            animation: parpadeo 0.3s infinite;
        }
        @keyframes parpadeo {
            0% { background-color: #ff0000; }
            50% { background-color: #8b0000; }
            100% { background-color: #ff0000; }
        }
    </style>
</head>
<body>

    <h1>üö® Sensor Antirrobo</h1>
    
    <div id="avisoHttps" style="color: red; font-weight: bold; display: none; margin-bottom: 15px;">
        ‚ö†Ô∏è Est√°s usando una conexi√≥n no segura. El GPS y los sensores podr√≠an no funcionar.
    </div>

    <button class="btn" id="btnActivar" onclick="iniciarVigilancia()">1. Activar Vigilancia</button>
    
    <div id="estado">Estado: Apagado</div>
    <div id="coordenadas">GPS: Apagado (Ahorrando bater√≠a)</div>

    <button class="btn btn-test" id="btnSimular" onclick="procesarMovimiento()">üõ†Ô∏è Simular Golpe manual</button>

    <script>
        // Mostrar aviso si el archivo se abre localmente (file://) o en http://
        if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost') {
            document.getElementById('avisoHttps').style.display = 'block';
        }

        let vigilando = false;
        let nivelAlarma = 0; 
        let tiempoUltimoAviso = 0;
        
        let sonidoAviso = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');
        let sonidoAlarma = new Audio('https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg');
        sonidoAlarma.loop = true;

        let lastX = null, lastY = null, lastZ = null;

        function iniciarVigilancia() {
            // Desbloquear audios
            sonidoAviso.play().then(() => sonidoAviso.pause()).catch(e => console.log("Audio bloqueado temporalmente"));
            sonidoAlarma.play().then(() => sonidoAlarma.pause()).catch(e => console.log("Audio bloqueado temporalmente"));

            if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                DeviceMotionEvent.requestPermission()
                    .then(estado => {
                        if (estado === 'granted') activarSensores();
                        else alert("Permiso de movimiento denegado.");
                    })
                    .catch(console.error);
            } else {
                activarSensores();
            }
        }

        function activarSensores() {
            vigilando = true;
            document.getElementById('estado').innerText = "üü¢ Vigilando... ¬°No lo muevas!";
            document.getElementById('btnActivar').style.display = "none";
            document.getElementById('btnSimular').style.display = "inline-block"; // Mostramos el bot√≥n de prueba
            
            window.addEventListener('devicemotion', (evento) => {
                if (!vigilando || nivelAlarma === 2) return;

                // Intentar usar aceleraci√≥n con gravedad, si no, aceleraci√≥n normal
                let acc = evento.accelerationIncludingGravity || evento.acceleration;
                if (!acc || acc.x === null) return;

                let x = acc.x; let y = acc.y; let z = acc.z;

                if (lastX !== null) {
                    let diffX = Math.abs(x - lastX);
                    let diffY = Math.abs(y - lastY);
                    let diffZ = Math.abs(z - lastZ);
                    
                    let movimientoTotal = diffX + diffY + diffZ;

                    if (movimientoTotal > 10) { // Umbral de sensibilidad
                        procesarMovimiento();
                    }
                }
                lastX = x; lastY = y; lastZ = z;
            });
        }

        function procesarMovimiento() {
            let ahora = Date.now();

            if (nivelAlarma === 0) {
                // FASE 1: AVISO
                nivelAlarma = 1;
                tiempoUltimoAviso = ahora;
                
                sonidoAviso.currentTime = 0;
                sonidoAviso.play();
                
                document.body.classList.add('alerta-amarilla');
                document.getElementById('estado').innerText = "‚ö†Ô∏è ¬°ADVERTENCIA! Movimiento detectado";
                
                iniciarRastreoGPS();

            } else if (nivelAlarma === 1) {
                // FASE 2: ALARMA (Si han pasado m√°s de 1.5 segundos desde el aviso)
                if (ahora - tiempoUltimoAviso > 1500) {
                    dispararAlarmaFinal();
                }
            }
        }

        function iniciarRastreoGPS() {
            document.getElementById('coordenadas').innerText = "üìç GPS: Buscando sat√©lites...";
            
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(
                    (posicion) => {
                        let lat = posicion.coords.latitude;
                        let lon = posicion.coords.longitude;
                        document.getElementById('coordenadas').innerText = `üìç GPS Actualizado: \nLat: ${lat.toFixed(5)} \nLon: ${lon.toFixed(5)}`;
                    }, 
                    (error) => {
                        document.getElementById('coordenadas').innerText = "‚ùå Error GPS: " + error.message;
                    }, 
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            } else {
                document.getElementById('coordenadas').innerText = "‚ùå Tu navegador no soporta GPS.";
            }
        }

        function dispararAlarmaFinal() {
            nivelAlarma = 2;
            document.body.classList.remove('alerta-amarilla');
            document.body.classList.add('alerta-roja');
            document.getElementById('estado').innerText = "üî¥ ¬°ROBO CONFIRMADO!";
            sonidoAlarma.play();
        }
    </script>
</body>
</html>
