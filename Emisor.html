<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dispositivo Vigilante - Conectado</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; padding: 20px; background-color: #f4f4f4; transition: background 0.2s; }
        .btn { padding: 20px 30px; font-size: 20px; background-color: #4CAF50; color: white; border: none; border-radius: 10px; cursor: pointer; margin: 10px; box-shadow: 0px 4px 6px rgba(0,0,0,0.2); }
        .btn-test { background-color: #555; font-size: 16px; padding: 15px 20px; display: none; }
        #estado { margin-top: 30px; font-size: 22px; font-weight: bold; color: #333; padding: 20px; border-radius: 10px; }
        #coordenadas { margin-top: 15px; font-size: 16px; color: #444; background: #fff; padding: 10px; border-radius: 8px; border: 1px solid #ddd; }
        .alerta-amarilla { background-color: #ffcc00 !important; }
        .alerta-roja { background-color: #ff0000 !important; color: white !important; animation: parpadeo 0.3s infinite; }
        @keyframes parpadeo { 0% { background-color: #ff0000; } 50% { background-color: #8b0000; } 100% { background-color: #ff0000; } }
    </style>
</head>
<body>

    <h1>üö® Sensor Antirrobo</h1>
    <button class="btn" id="btnActivar" onclick="iniciarVigilancia()">1. Activar Vigilancia</button>
    <div id="estado">Estado: Apagado</div>
    <div id="coordenadas">GPS: Apagado</div>
    <button class="btn btn-test" id="btnSimular" onclick="procesarMovimiento()">üõ†Ô∏è Simular Golpe</button>

    <script type="module">
        // 1. Importamos Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
        import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

        // 2. Tu configuraci√≥n exacta
        const firebaseConfig = {
            apiKey: "AIzaSyCtStv8wmlLNOhiw0lnc9mzVlQwLXrYdbY",
            authDomain: "antirrobo-457ef.firebaseapp.com",
            projectId: "antirrobo-457ef",
            storageBucket: "antirrobo-457ef.firebasestorage.app",
            messagingSenderId: "237396778046",
            appId: "1:237396778046:web:6da1715323e4581142856f"
        };

        // 3. Inicializamos la base de datos
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- L√≥gica de la alarma ---
        let vigilando = false;
        let nivelAlarma = 0; 
        let tiempoUltimoAviso = 0;
        let lastX = null, lastY = null, lastZ = null;
        
        // Coordenadas base (Irun por defecto por si salta la alarma antes de coger GPS)
        let latActual = 43.3390; 
        let lonActual = -1.7896;

        let sonidoAviso = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');
        let sonidoAlarma = new Audio('https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg');
        sonidoAlarma.loop = true;

        // Funci√≥n para enviar datos a la nube
        function enviarDatos() {
            setDoc(doc(db, "dispositivos", "mi_bici"), {
                latitud: latActual,
                longitud: lonActual,
                nivelAlarma: nivelAlarma,
                tiempo: Date.now()
            }).then(() => console.log("Datos enviados a Firebase"))
              .catch(e => console.error("Error al enviar:", e));
        }

        // Exponemos las funciones para que los botones HTML puedan usarlas
        window.iniciarVigilancia = function() {
            sonidoAviso.play().then(() => sonidoAviso.pause()).catch(e => console.log("Audio en espera"));
            sonidoAlarma.play().then(() => sonidoAlarma.pause()).catch(e => console.log("Audio en espera"));

            if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                DeviceMotionEvent.requestPermission().then(estado => {
                    if (estado === 'granted') activarSensores();
                }).catch(console.error);
            } else {
                activarSensores();
            }
        };

        function activarSensores() {
            vigilando = true;
            document.getElementById('estado').innerText = "üü¢ Vigilando...";
            document.getElementById('btnActivar').style.display = "none";
            document.getElementById('btnSimular').style.display = "inline-block";
            
            // Enviamos estado seguro al inicio
            enviarDatos();
            
            window.addEventListener('devicemotion', (evento) => {
                if (!vigilando || nivelAlarma === 2) return;
                let acc = evento.accelerationIncludingGravity || evento.acceleration;
                if (!acc || acc.x === null) return;

                if (lastX !== null) {
                    let diff = Math.abs(acc.x - lastX) + Math.abs(acc.y - lastY) + Math.abs(acc.z - lastZ);
                    if (diff > 10) window.procesarMovimiento();
                }
                lastX = acc.x; lastY = acc.y; lastZ = acc.z;
            });
        }

        window.procesarMovimiento = function() {
            let ahora = Date.now();
            if (nivelAlarma === 0) {
                nivelAlarma = 1;
                tiempoUltimoAviso = ahora;
                sonidoAviso.currentTime = 0; sonidoAviso.play();
                document.body.classList.add('alerta-amarilla');
                document.getElementById('estado').innerText = "‚ö†Ô∏è ADVERTENCIA";
                enviarDatos(); // Avisamos a Firebase
                iniciarRastreoGPS();
            } else if (nivelAlarma === 1 && (ahora - tiempoUltimoAviso > 1500)) {
                nivelAlarma = 2;
                document.body.classList.replace('alerta-amarilla', 'alerta-roja');
                document.getElementById('estado').innerText = "üî¥ ¬°ROBO CONFIRMADO!";
                sonidoAlarma.play();
                enviarDatos(); // Avisamos a Firebase
            }
        };

        function iniciarRastreoGPS() {
            document.getElementById('coordenadas').innerText = "üìç Buscando GPS...";
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition((posicion) => {
                    latActual = posicion.coords.latitude;
                    lonActual = posicion.coords.longitude;
                    document.getElementById('coordenadas').innerText = `üìç GPS: ${latActual.toFixed(4)}, ${lonActual.toFixed(4)}`;
                    enviarDatos(); // Si el GPS se mueve, actualizamos Firebase
                }, (error) => {
                    document.getElementById('coordenadas').innerText = "‚ùå Error GPS";
                }, { enableHighAccuracy: true });
            }
        }
    </script>
</body>
</html>
